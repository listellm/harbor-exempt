{% extends "base.html" %}

{% block title %}{{ vuln.cve_id }} — {{ project_name }}{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/projects">Projects</a>
    <span class="separator">/</span>
    <a href="/projects/{{ project_name }}">{{ project_name }}</a>
    <span class="separator">/</span>
    <span>{{ vuln.cve_id }}</span>
</div>

<div class="page-header">
    <div class="flex items-center gap-1">
        <h1 class="mono">{{ vuln.cve_id }}</h1>
        <span class="severity-badge severity-{{ vuln.severity|lower }}">{{ vuln.severity }}</span>
        <span class="status-badge status-{{ vuln.status }}">{{ vuln.status }}</span>
    </div>
</div>

<div class="card mb-2">
    <div class="detail-grid">
        <div class="detail-item">
            <label>Package</label>
            <span class="mono">{{ vuln.package }}</span>
        </div>
        <div class="detail-item">
            <label>Repository</label>
            <span class="mono">{{ vuln.repository }}</span>
        </div>
        <div class="detail-item">
            <label>Installed version</label>
            <span class="mono">{{ vuln.installed_version or '—' }}</span>
        </div>
        <div class="detail-item">
            <label>Fixed version</label>
            {% if vuln.fixed_version %}<span class="fix-available"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.106-3.105c.32-.322.863-.22.983.218a6 6 0 0 1-8.259 7.057l-7.91 7.91a1 1 0 0 1-2.999-3l7.91-7.91a6 6 0 0 1 7.057-8.259c.438.12.54.662.219.984z"/></svg>{{ vuln.fixed_version }}</span>{% else %}<span class="mono text-muted">—</span>{% endif %}
        </div>
        <div class="detail-item">
            <label title="When this vulnerability was first detected on this image">Vuln first seen</label>
            <span>{{ vuln.first_seen_at|format_datetime }}</span>
        </div>
        <div class="detail-item">
            <label title="Most recent scan that still reported this vulnerability">Vuln last seen</label>
            <span>{{ vuln.last_seen_at|format_datetime }}</span>
        </div>
    </div>

    {% if vuln.description %}
    <div class="mt-2">
        <label style="display: block; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Description</label>
        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6;">{{ vuln.description }}</p>
    </div>
    {% endif %}

    {% if vuln.references %}
    <div class="mt-2">
        <label style="display: block; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">References</label>
        <ul style="list-style: none; font-size: 0.8125rem;">
            {% for ref in vuln.references %}
            <li style="margin-bottom: 0.25rem;"><a href="{{ ref }}" target="_blank" rel="noopener noreferrer">{{ ref }}</a></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

{# Active acceptance #}
{% if active_acceptance %}
<div class="card mb-2" style="border-color: var(--success);">
    <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--success);">Active Acceptance</h3>
    <div class="detail-grid">
        <div class="detail-item">
            <label>Accepted by</label>
            <span>{{ active_acceptance.accepted_by }}</span>
        </div>
        <div class="detail-item">
            <label>Expires</label>
            <span>{{ active_acceptance.expires_at|format_datetime }}</span>
        </div>
        <div class="detail-item">
            <label>Created</label>
            <span>{{ active_acceptance.created_at|format_datetime }}</span>
        </div>
    </div>
    <div class="mt-1">
        <label style="display: block; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Justification</label>
        <p style="font-size: 0.875rem; color: var(--text-secondary);">{{ active_acceptance.justification }}</p>
    </div>
    {% if is_admin %}
    <div class="mt-2">
        <button class="btn btn-sm btn-danger"
                hx-post="/ui/revoke"
                hx-vals='{"acceptance_id": "{{ active_acceptance.id }}", "vulnerability_id": "{{ vuln.id }}", "project_name": "{{ project_name }}"}'
                hx-target="body"
                hx-swap="outerHTML"
                hx-confirm="Revoke this acceptance?">Revoke Acceptance</button>
    </div>
    {% endif %}
</div>
{% endif %}

{# Actions #}
{% if is_admin and vuln.status == 'open' %}
<div class="card mb-2" id="accept-section">
    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Accept Risk</h3>
    <form hx-post="/ui/accept"
          hx-target="#accept-section"
          hx-swap="outerHTML">
        <input type="hidden" name="vulnerability_id" value="{{ vuln.id }}">
        <input type="hidden" name="project_name" value="{{ project_name }}">
        <input type="hidden" name="redirect" value="/projects/{{ project_name }}/vulnerabilities/{{ vuln.id }}">
        <div class="form-group">
            <label for="justification">Justification</label>
            <textarea name="justification" id="justification" class="form-control" rows="3"
                      required placeholder="Why is this risk acceptable?"></textarea>
        </div>
        <div class="form-group">
            <label for="expires_at">Expires</label>
            <input type="text" name="expires_at" id="expires_at" class="form-control flatpickr-date"
                   required placeholder="Select date" style="max-width: 200px;">
        </div>
        <button type="submit" class="btn btn-primary">
            Accept Risk
            <span class="htmx-indicator spinner"></span>
        </button>
    </form>
</div>
{% endif %}

{# Acceptance history #}
<div class="card">
    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Acceptance History</h3>
    {% if acceptances %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Action</th>
                    <th>By</th>
                    <th>Justification</th>
                    <th>Expires</th>
                    <th>Created</th>
                    <th>Revoked</th>
                </tr>
            </thead>
            <tbody>
                {% for acc in acceptances %}
                <tr>
                    <td>
                        {% if acc.revoked_at %}
                            <span class="status-badge status-open">Revoked</span>
                        {% elif acc.expires_at and acc.expires_at < now %}
                            <span class="status-badge" style="background-color: var(--warning-bg); color: var(--warning);">Expired</span>
                        {% else %}
                            <span class="status-badge status-accepted">Active</span>
                        {% endif %}
                    </td>
                    <td>{{ acc.accepted_by }}</td>
                    <td style="max-width: 300px;">{{ acc.justification }}</td>
                    <td class="text-muted">{{ acc.expires_at|format_datetime }}</td>
                    <td class="text-muted">{{ acc.created_at|format_datetime }}</td>
                    <td class="text-muted">
                        {% if acc.revoked_at %}
                            {{ acc.revoked_at|format_datetime }} by {{ acc.revoked_by or '—' }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-muted" style="font-size: 0.875rem;">No acceptance history for this vulnerability.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    flatpickr('.flatpickr-date', {
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'd/m/Y',
        defaultDate: new Date().fp_incr(1),
        minDate: 'today',
        maxDate: new Date().fp_incr({{ max_expiry_days }}),
        theme: 'dark'
    });
</script>
{% endblock %}
