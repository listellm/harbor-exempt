{% extends "base.html" %}

{% block title %}{{ repository }}{% endblock %}

{% block content %}
<div class="breadcrumb">
    {% if request.query_params.get('from') == 'accepted' %}
    <a href="/accepted">Accepted Images</a>
    {% else %}
    <a href="/">Images</a>
    {% endif %}
    <span class="separator">/</span>
    <span>{{ repository }}</span>
</div>

<div class="page-header">
    <h1 class="mono" style="font-size: 1.25rem;">{% if latest_tag %}{{ repository }}:{{ latest_tag }}{% else %}{{ latest_image or repository }}{% endif %}</h1>
    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
        <span class="text-secondary" style="font-size: 0.875rem;">Project: <a href="/projects/{{ project_name }}">{{ project_name }}</a></span>
        {% if threshold %}
        <span class="severity-badge severity-{{ threshold }}" style="font-size: 0.625rem; padding: 0.0625rem 0.375rem;" title="Threshold: {{ threshold|upper }}+">
            {{ threshold|upper }}
        </span>
        {% endif %}
        {% if latest_digest %}
        <span class="text-muted" style="font-size: 0.8125rem;" title="{{ latest_digest }}">{{ latest_digest[:19] }}...</span>
        {% endif %}
        {% if last_scanned %}
        <span class="text-muted" style="font-size: 0.8125rem;">Scanned: {{ last_scanned|format_datetime }}</span>
        {% endif %}
    </div>
</div>

<div class="alert alert-warning" style="margin-bottom: 1rem;">
    Accepting or revoking a CVE here applies to the entire <strong>{{ project_name }}</strong> project â€” all images in this project will be affected.
</div>

<div class="filter-bar">
    <form class="form-inline"
          hx-get="/partials/images/vulnerabilities?project={{ project_name }}&repo={{ repository }}"
          hx-target="#vuln-table-body"
          hx-swap="outerHTML"
          hx-select="tbody"
          hx-trigger="submit, change from:.checkbox-group, refreshVulnTable from:body"
          hx-indicator=".filter-indicator">
        <div class="form-group filter-group">
            <label>Status</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="status" value="open" {% if 'open' in (status or []) %}checked{% endif %}> Open</label>
                <label><input type="checkbox" name="status" value="accepted" {% if 'accepted' in (status or []) %}checked{% endif %}> Accepted</label>
                <label><input type="checkbox" name="status" value="fixed" {% if 'fixed' in (status or []) %}checked{% endif %}> Fixed</label>
            </div>
        </div>
        <div class="form-group filter-group">
            <label>Severity</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="severity" value="CRITICAL" {% if 'CRITICAL' in (severity or []) %}checked{% endif %}> Critical</label>
                <label><input type="checkbox" name="severity" value="HIGH" {% if 'HIGH' in (severity or []) %}checked{% endif %}> High</label>
                <label><input type="checkbox" name="severity" value="MEDIUM" {% if 'MEDIUM' in (severity or []) %}checked{% endif %}> Medium</label>
                <label><input type="checkbox" name="severity" value="LOW" {% if 'LOW' in (severity or []) %}checked{% endif %}> Low</label>
                <label><input type="checkbox" name="severity" value="UNKNOWN" {% if 'UNKNOWN' in (severity or []) %}checked{% endif %}> Unknown</label>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">
            Apply
            <span class="htmx-indicator spinner"></span>
        </button>
    </form>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>CVE</th>
                    <th>Package</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Installed</th>
                    <th>Fixed</th>
                    <th title="When this vulnerability was first detected on this image">Vuln first seen</th>
                    <th title="Most recent scan that still reported this vulnerability">Vuln last seen</th>
                    <th>Actions</th>
                </tr>
            </thead>
            {% include "partials/vuln_table.html" %}
        </table>
    </div>
</div>
{% endblock %}
